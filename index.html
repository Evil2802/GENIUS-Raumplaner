<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Raumplanung Nachhilfe</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #eef2f7;
      padding: 20px;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .login, .dashboard {
      max-width: 900px;
      width: 100%;
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    }
    h2 {
      margin-top: 0;
      color: #2c3e50;
      font-weight: 700;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px 10px;
      font-size: 1rem;
      border: 2px solid #2980b9;
      border-radius: 6px;
      margin-bottom: 15px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #1abc9c;
      box-shadow: 0 0 5px #1abc9c;
    }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      font-weight: 600;
      background-color: #2980b9;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover:not(:disabled) {
      background-color: #1abc9c;
    }
    button:disabled {
      background-color: #95a5a6;
      cursor: default;
    }
    .error {
      color: #e74c3c;
      font-weight: 600;
      margin-bottom: 15px;
    }

    /* Kalender Styles */
    #monthContainer {
      margin-top: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .dayCard {
      background: #f7f9fc;
      border-radius: 10px;
      width: 110px;
      padding: 12px 10px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: background-color 0.3s, transform 0.15s;
      user-select: none;
    }
    .dayCard:hover {
      background-color: #d0f0e4;
      transform: translateY(-3px);
    }
    .dayCard.selected {
      background-color: #1abc9c;
      color: white;
      font-weight: 700;
      transform: translateY(-5px);
      box-shadow: 0 5px 12px rgba(26,188,156,0.5);
    }
    .dayLabel {
      font-weight: 600;
      font-size: 0.85rem;
      color: #34495e;
      margin-bottom: 6px;
      text-align: center;
    }
    .dateLabel {
      font-size: 1.3rem;
      font-weight: 700;
      text-align: center;
      user-select: none;
    }

    /* Zeitfenster */
    #timeSlotsContainer {
      margin-top: 25px;
      max-width: 900px;
      background: white;
      border-radius: 12px;
      padding: 20px 25px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.1);
      display: none;
    }
    .timeSlot {
      border: 1.5px solid #2980b9;
      border-radius: 8px;
      margin: 5px;
      padding: 12px 8px;
      cursor: pointer;
      user-select: none;
      display: inline-block;
      width: 120px;
      text-align: center;
      font-weight: 600;
      color: #2980b9;
      transition: background-color 0.3s, color 0.3s;
    }
    .timeSlot.booked {
      background-color: #e74c3c;
      color: white;
      cursor: default;
      border-color: #c0392b;
    }
    .timeSlot.bookedByUser {
      background-color: #27ae60;
      color: white;
      border-color: #1e8449;
    }
    .timeSlot:hover:not(.booked) {
      background-color: #1abc9c;
      color: white;
      border-color: #16a085;
    }
    #selectedDateTitle {
      font-weight: 700;
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: #2c3e50;
    }
  </style>
</head>
<body>

<div class="login" id="loginBox">
  <h2>Login</h2>
  <p>Gib deinen Namen ein (nur erlaubte Personen):</p>
  <input type="text" id="username" placeholder="z. B. Anna Müller" autocomplete="off" />
  <div class="error" id="loginError" style="display:none;"></div>
  <button id="loginBtn">Einloggen</button>
</div>

<div class="dashboard" id="dashboard" style="display:none">
  <h2>Willkommen, <span id="userDisplay"></span></h2>
  <p>Wähle ein Datum unten aus und trage dich für 30 Minuten Zeitfenster in Raum A oder B ein.</p>

  <div id="monthContainer"></div>

  <div id="timeSlotsContainer">
    <div id="selectedDateTitle"></div>
    <div><strong>Raum A</strong></div>
    <div id="timeSlotsA"></div>
    <br>
    <div><strong>Raum B</strong></div>
    <div id="timeSlotsB"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
  // Firebase-Konfiguration hier einsetzen (deine Daten)
  const firebaseConfig = {
    apiKey: "AIzaSyApOdRm_xgUhPbeBeFJ6NPHOt4LSBUJiIo",
    authDomain: "genius-raumplaner.firebaseapp.com",
    databaseURL: "https://genius-raumplaner-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "genius-raumplaner",
    storageBucket: "genius-raumplaner.appspot.com",
    messagingSenderId: "1081346940014",
    appId: "1:1081346940014:web:d6b00e0f7d3cd1fb125a7f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Zulässige Namen (Whitelist), Kleinschreibung ignorieren
  const allowedUsers = ["anna müller", "max mustermann", "lara schmidt"];

  let aktuellerUser = "";
  let selectedDate = null;
  let bookings = {}; // alle Buchungen aus DB

  // Hilfsfunktion: Zeitfenster von 6:00 bis 20:00 in 30 Min Schritten
  function generateTimeSlots(startHour = 6, endHour = 20) {
    const slots = [];
    for (let h = startHour; h < endHour; h++) {
      slots.push(`${String(h).padStart(2, "0")}:00-${String(h).padStart(2, "0")}:30`);
      slots.push(`${String(h).padStart(2, "0")}:30-${String(h+1).padStart(2, "0")}:00`);
    }
    return slots;
  }

  const timeSlots = generateTimeSlots();

  // Erstelle 30 Tage ab heute als Datum-Strings + Wochentage
  function getDaysArray() {
    const days = [];
    const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
    for(let i=0; i<30; i++) {
      const d = new Date();
      d.setDate(d.getDate() + i);
      const dateStr = d.toISOString().split('T')[0];
      days.push({
        date: dateStr,
        dayName: dayNames[d.getDay()],
        dayNum: d.getDate()
      });
    }
    return days;
  }

  // UI-Elemente
  const loginBox = document.getElementById('loginBox');
  const dashboard = document.getElementById('dashboard');
  const userDisplay = document.getElementById('userDisplay');
  const monthContainer = document.getElementById('monthContainer');
  const timeSlotsContainer = document.getElementById('timeSlotsContainer');
  const selectedDateTitle = document.getElementById('selectedDateTitle');
  const timeSlotsA = document.getElementById('timeSlotsA');
  const timeSlotsB = document.getElementById('timeSlotsB');
  const loginError = document.getElementById('loginError');
  const loginBtn = document.getElementById('loginBtn');
  const usernameInput = document.getElementById('username');

  // Login Event
  loginBtn.addEventListener('click', () => {
    const enteredName = usernameInput.value.trim();
    if (!enteredName) {
      showError("Bitte gib deinen Namen ein.");
      return;
    }
    if (!allowedUsers.includes(enteredName.toLowerCase())) {
      showError("Dein Name ist nicht in der Liste der erlaubten Nutzer.");
      return;
    }
    aktuellerUser = enteredName;
    loginBox.style.display = "none";
    dashboard.style.display = "block";
    userDisplay.textContent = aktuellerUser;
    loginError.style.display = "none";
    loadBookings();
    renderCalendar();
  });

  function showError(msg) {
    loginError.style.display = "block";
    loginError.textContent = msg;
  }

  // Kalender rendern
  function renderCalendar() {
    monthContainer.innerHTML = "";
    const days = getDaysArray();
    days.forEach(day => {
      const card = document.createElement('div');
      card.classList.add('dayCard');
      card.dataset.date = day.date;
      card.innerHTML = `
        <div class="dayLabel">${day.dayName}</div>
        <div class="dateLabel">${day.dayNum}</div>
      `;
      card.addEventListener('click', () => {
        selectDate(day.date);
      });
      monthContainer.appendChild(card);
    });
  }

  // Datum auswählen
  function selectDate(date) {
    selectedDate = date;
    selectedDateTitle.textContent = `Gebuchte Zeiten am ${selectedDate}`;
    timeSlotsContainer.style.display = "block";

    // Markiere ausgewählten Tag
    document.querySelectorAll('.dayCard').forEach(card => {
      card.classList.toggle('selected', card.dataset.date === date);
    });

    renderTimeSlots();
  }

  // Lade alle Buchungen aus Firebase
  function loadBookings() {
    db.ref('bookings').on('value', (snapshot) => {
      bookings = snapshot.val() || {};
      if(selectedDate) renderTimeSlots();
    });
  }

  // Zeitfenster anzeigen mit Buchungsstatus
  function renderTimeSlots() {
    timeSlotsA.innerHTML = "";
    timeSlotsB.innerHTML = "";

    timeSlots.forEach(slot => {
      // Raum A
      const bookedByA = bookings[selectedDate]?.[slot]?.A || "";
      const slotA = document.createElement('div');
      slotA.className = "timeSlot";
      if(bookedByA) {
        if(bookedByA.toLowerCase() === aktuellerUser.toLowerCase()) {
          slotA.classList.add('bookedByUser');
          slotA.textContent = `${slot} (Du) - Raum A`;
          slotA.title = "Klicke zum Austragen";
          slotA.addEventListener('click', () => {
            austragen(selectedDate, slot, 'A');
          });
        } else {
          slotA.classList.add('booked');
          slotA.textContent = `${slot} (Belegt) - Raum A`;
        }
      } else {
        slotA.textContent = `${slot} - Raum A`;
        slotA.title = "Klicke zum Eintragen";
        slotA.addEventListener('click', () => {
          eintragen(selectedDate, slot, 'A');
        });
      }
      timeSlotsA.appendChild(slotA);

      // Raum B
      const bookedByB = bookings[selectedDate]?.[slot]?.B || "";
      const slotB = document.createElement('div');
      slotB.className = "timeSlot";
      if(bookedByB) {
        if(bookedByB.toLowerCase() === aktuellerUser.toLowerCase()) {
          slotB.classList.add('bookedByUser');
          slotB.textContent = `${slot} (Du) - Raum B`;
          slotB.title = "Klicke zum Austragen";
          slotB.addEventListener('click', () => {
            austragen(selectedDate, slot, 'B');
          });
        } else {
          slotB.classList.add('booked');
          slotB.textContent = `${slot} (Belegt) - Raum B`;
        }
      } else {
        slotB.textContent = `${slot} - Raum B`;
        slotB.title = "Klicke zum Eintragen";
        slotB.addEventListener('click', () => {
          eintragen(selectedDate, slot, 'B');
        });
      }
      timeSlotsB.appendChild(slotB);
    });
  }

  // Eintragen in Firebase
  function eintragen(date, timeSlot, room) {
    if (!aktuellerUser) return;
    // Check if slot is free
    const currentBooking = bookings[date]?.[timeSlot]?.[room];
    if(currentBooking && currentBooking.toLowerCase() !== aktuellerUser.toLowerCase()) {
      alert("Dieser Termin ist bereits belegt.");
      return;
    }
    db.ref(`bookings/${date}/${timeSlot}/${room}`).set(aktuellerUser)
      .catch(err => alert("Fehler beim Eintragen: " + err.message));
  }

  // Austragen in Firebase
  function austragen(date, timeSlot, room) {
    if (!aktuellerUser) return;
    const currentBooking = bookings[date]?.[timeSlot]?.[room];
    if(currentBooking && currentBooking.toLowerCase() === aktuellerUser.toLowerCase()) {
      db.ref(`bookings/${date}/${timeSlot}/${room}`).remove()
        .catch(err => alert("Fehler beim Austragen: " + err.message));
    }
  }

</script>

</body>
</html>
